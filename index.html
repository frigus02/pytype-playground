<!DOCTYPE html>
<html>
  <head>
    <title>Pytype Playground</title>
    <style>
      textarea,
      output {
        display: block;
        white-space: preserve;
        font-family: monospace;
      }
      textarea {
        width: 500px;
        height: 100px;
      }
    </style>
  </head>
  <body>
    <h1>Pytype Playground</h1>
    <textarea id="input"></textarea>
    <button id="check">Check</button>
    <output id="pytypeOutput"></output>
    <script type="module">
      const pytypeWorker = new Worker("./worker.js");

      function now() {
        return new Date().toLocaleString();
      }

      let currentTask = undefined;
      let queuedTask = undefined;
      function runPytype(src) {
        const { promise, resolve, reject } = Promise.withResolvers();
        if (!currentTask) {
          pytypeWorker.postMessage({ src });
          currentTask = { resolve, reject };
          setupFinally(promise);
        } else {
          queuedTask?.reject(new Error("cancelled"));
          queuedTask = { promise, resolve, reject, src };
        }
        return promise;
      }
      function setupFinally(promise) {
        promise.finally(() => {
          if (queuedTask) {
            const { promise, resolve, reject, src } = queuedTask;
            pytypeWorker.postMessage({ src });
            currentTask = { resolve, reject };
            setupFinally(promise);
            queuedTask = undefined;
          } else {
            currentTask = undefined;
          }
        });
      }
      pytypeWorker.onmessage = ({ data }) => {
        if ("notify" in data) {
          pytypeOutput.innerText = `[${now()}] ${data.notify}\n`;
        } else if ("result" in data) {
          currentTask?.resolve(data.result);
        } else if ("error" in data) {
          currentTask?.reject(data.error);
        } else {
          pytypeOutput.innerText = `[${now()}] Unexpected message from worker.\n`;
          console.log(data);
        }
      };

      input.value = ["def foo(x):", "  return x + 2", "", 'foo("1")'].join(
        "\n"
      );

      check.onclick = async () => {
        try {
          const result = await runPytype(input.value);
          pytypeOutput.innerText = `[${now()}] ${result}\n`;
        } catch (e) {
          pytypeOutput.innerText = `[${now()}] ${e}\n`;
        }
      };
    </script>
  </body>
</html>
